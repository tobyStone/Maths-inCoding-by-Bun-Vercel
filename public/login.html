const jwt = require('jsonwebtoken');
const Teacher = require('../models/teacherModel');
const Student = require('../models/studentModel');
const QuizResults = require('../models/quizResultModel');
const db = require('./database'); // Your database connection logic
require('dotenv').config();

const JWT_SECRET = process.env.JWT_SECRET;

/**
 * Middleware to authenticate and authorize teachers.
 * Verifies the JWT token and checks if the user is a teacher.
 */
const authenticateTeacher = async (req, res) => {
    const token = req.headers.authorization && req.headers.authorization.split(' ')[1];
    if (!token) {
        res.status(401).json({ message: 'Unauthorized: No token provided' });
        return null; // Ensure function exits after sending a response
    }

    try {
        // Verify the token and decode it
        const decoded = jwt.verify(token, JWT_SECRET);

        // Ensure the role is 'teacher'
        if (decoded.role !== 'teacher') {
            res.status(403).json({ message: 'Forbidden: You are not authorized to access this route' });
            return null; // Ensure function exits after sending a response
        }

        // Fetch the teacher using the decoded ID
        const teacher = await Teacher.findById(decoded.id);
        if (!teacher) {
            res.status(404).json({ message: 'Teacher not found' });
            return null; // Ensure function exits after sending a response
        }

        return teacher; // Return teacher if found
    } catch (error) {
        console.error('Error verifying token:', error);
        res.status(401).json({ message: 'Invalid token' });
        return null; // Ensure function exits after sending a response
    }
};

const getFormattedDate = (date, country) => {
    const parsedDate = new Date(date);
    if (isNaN(parsedDate.getTime())) return 'Invalid Date';

    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
    return parsedDate.toLocaleDateString(country === 'GB' ? 'en-GB' : 'en-US', options);
};

module.exports = async (req, res) => {
    if (req.method !== 'GET') {
        res.setHeader('Allow', ['GET']);
        return res.status(405).end(`Method ${req.method} Not Allowed`);
    }

    try {
        await db.connectToDatabase();

        // Authenticate the teacher
        const teacher = await authenticateTeacher(req, res);
        if (!teacher) return; // Exit if authentication fails

        // Fetch students associated with the authenticated teacher
        const students = await Student.find({ teacher: teacher._id }).lean();
        if (!students || students.length === 0) {
            res.status(404).send('<h2>No students found for this teacher.</h2>');
            return; // Ensure function exits after sending a response
        }

        // Collect all student IDs to query their quiz results
        const studentIds = students.map(student => student._id);

        // Fetch quiz results for all students associated with the teacher
        const quizResults = await QuizResults.find({ student: { $in: studentIds } }).populate('student', 'name email');

        const country = req.headers['x-vercel-ip-country'] || 'US';
        const resultsByStudent = quizResults.reduce((acc, result) => {
            if (!acc[result.student._id]) {
                acc[result.student._id] = {
                    studentName: result.student.name,
                    email: result.student.email,
                    scores: {},
                    passedResults: []
                };
            }
            if (result.passed) {
                acc[result.student._id].passedResults.push({
                    quizId: result.quizId,
                    score: result.score,
                    date: getFormattedDate(result.date, country)
                });
            } else {
                if (!acc[result.student._id].scores[result.quizId]) {
                    acc[result.student._id].scores[result.quizId] = { count: 0, dates: [] };
                }
                acc[result.student._id].scores[result.quizId].count += 1;
                acc[result.student._id].scores[result.quizId].dates.push(getFormattedDate(result.date, country));
            }
            return acc;
        }, {});

        // Prepare the response HTML for the teacher's dashboard
        const html = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        h1 {
            text-align: center;
        }

        .student-container {
            margin: 20px;
            padding: 10px;
            border: 1px solid #ccc;
        }

        .student-details {
            margin-bottom: 15px;
        }

        .quiz-result {
            margin-left: 20px;
        }

        .yellow {
            background-color: yellow;
        }

        .orange {
            background-color: orange;
        }

        .red {
            background-color: red;
        }

        .passed {
            color: green;
            font-weight: bold;
        }

        .failed {
            color: red;
            font-weight: bold;
        }

        .red .failed {
            color: white;
        }
    </style>
</head>
<body>
    <h1>Welcome ${teacher.name}, here are your students' quiz results:</h1>
    ${Object.values(resultsByStudent).map(student => `
    <div class="student-container">
        <div class="student-details">
            <strong>${student.studentName} (${student.email})</strong>
        </div>
        <div class="quiz-results">
            ${Object.entries(student.scores).map(([quizId, result]) => `
            <div class="quiz-result ${result.count >= 3 ? 'red' : result.count === 2 ? 'orange' : 'yellow'}">
                Quiz: ${quizId} - ${result.count} ${result.count === 1 ? 'failure' : 'failures'} - Last Date: ${result.dates[result.dates.length - 1]}
            </div>
            `).join('')}
            ${student.passedResults.map(passed => `
            <div class="quiz-result">
                Quiz: ${passed.quizId} - Score: ${passed.score}% -
                <span class="passed">Passed</span> - Date: ${passed.date}
            </div>
            `).join('')}
        </div>
    </div>
    `).join('')}
</body>
</html>
        `;

        res.setHeader('Content-Type', 'text/html');
        res.status(200).send(html);

    } catch (error) {
        console.error('Error fetching teacher dashboard data:', error);
        if (!res.headersSent) {
            res.status(500).send('<h2>Internal server error. Please try again later.</h2>');
        }
    }
};
